<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SmartShop üá¨üá™</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <script>
    // ================= –ù–ê–°–¢–†–û–ô–ö–ò =================
    // –°—é–¥–∞ –≤—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É, –∫–æ—Ç–æ—Ä—É—é –¥–∞–ª Google Apps Script (–∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ /exec)
    const API_URL = "https://script.google.com/macros/s/AKfycbwyvKbWO6hiTKLptaMU-UUJuzCO_OSsnxIl9HUZDDzASGfu8ztpfEpx1tm9p5U-oA_R/exec";
    // =============================================
  </script>

  <style>
    body { background-color: #f0f2f5; font-family: 'Segoe UI', system-ui, sans-serif; }
    .product-card { border: none; border-radius: 16px; background: white; transition: transform 0.2s; overflow: hidden; }
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
    .img-wrap { height: 200px; overflow: hidden; position: relative; }
    .img-wrap img { width: 100%; height: 100%; object-fit: cover; }
    .auth-only { display: none !important; }
  </style>
</head>
<body>

<div class="container py-4">
  <header class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom">
    <div class="d-flex align-items-center">
      <span style="font-size: 2rem; margin-right: 10px;">üá¨üá™</span>
      <div><h2 class="fw-bold m-0 text-dark">SmartShop</h2><small class="text-muted">–¢–±–∏–ª–∏—Å–∏</small></div>
    </div>
    
    <!-- –ó–û–ù–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò -->
    <div id="auth-zone">
      <div id="g_id_onload"
         data-client_id="340428423135-3ja9dush1d6bj297v23oru8g0b4g8sk7.apps.googleusercontent.com" 
         data-callback="handleCredentialResponse"
         data-auto_prompt="true"
         data-cancel_on_tap_outside="false">
      </div>
      <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="filled_blue" data-text="signin_with" data-size="large"></div>
    </div>

    <!-- –ü–†–û–§–ò–õ–¨ -->
    <div id="profile-zone" class="d-none align-items-center bg-white px-3 py-2 rounded-pill shadow-sm">
      <img id="user-avatar" src="" class="rounded-circle me-2" style="width: 32px; height: 32px;">
      <div class="d-flex flex-column" style="line-height: 1;">
        <span id="user-name" class="fw-bold" style="font-size: 0.8rem;">User</span>
        <small id="user-email" class="text-muted" style="font-size: 0.7rem;"></small>
      </div>
      <button onclick="signOut()" class="btn btn-sm btn-link text-muted ms-2 p-0" title="–í—ã–π—Ç–∏" style="font-size: 0.8rem;">‚úï</button>
    </div>
  </header>

  <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-home">üõí –í–∏—Ç—Ä–∏–Ω–∞</button></li>
    <li class="nav-item"><button class="nav-link auth-only" id="orders-tab" data-bs-toggle="pill" data-bs-target="#pills-profile" onclick="loadMyOrders()">üì¶ –ú–æ–∏ –∑–∞–∫–∞–∑—ã</button></li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="pills-home">
      <div id="products-list" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        <div class="text-center w-100 py-5"><div class="spinner-border text-primary"></div><p class="mt-2 text-muted">–°–≤—è–∑—ã–≤–∞–µ–º—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º...</p></div>
      </div>
    </div>
    <div class="tab-pane fade" id="pills-profile">
      <div id="orders-container"><div class="text-center text-muted py-5">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div></div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow rounded-4">
      <div class="modal-header border-0"><h5 class="modal-title fw-bold">–ó–∞–∫–∞–∑</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="orderForm">
          <input type="hidden" id="prodId"><input type="hidden" id="prodTitle"><input type="hidden" id="prodPrice"><input type="hidden" id="prodStock">
          <div class="text-center mb-4"><h4 id="displayTitle" class="fw-bold mb-0"></h4><div class="text-primary fw-bold fs-5"><span id="displayPrice"></span> GEL</div></div>
          <div class="bg-light p-3 rounded-3 mb-3 d-flex justify-content-between align-items-center"><span class="fw-bold text-muted">–ö–æ–ª-–≤–æ:</span><div class="input-group" style="width: 120px;"><button class="btn btn-white border" type="button" onclick="updateQty(-1)">-</button><input type="text" class="form-control text-center bg-white" id="orderQty" value="1" readonly><button class="btn btn-white border" type="button" onclick="updateQty(1)">+</button></div></div>
          <div class="mb-3"><input type="text" id="custName" class="form-control" placeholder="–ò–º—è" required></div>
          <div class="mb-4"><input type="tel" id="custPhone" class="form-control" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" required></div>
          <button type="submit" id="submitBtn" class="btn btn-primary w-100 btn-lg fw-bold">–ó–∞–∫–∞–∑–∞—Ç—å</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  let modal;
  let currentUser = null;

  window.onload = function() {
    modal = new bootstrap.Modal(document.getElementById('orderModal'));
    loadProducts();
    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é –∏–∑ localStorage
    const saved = localStorage.getItem('smartstore_user');
    if (saved) {
      try {
        const user = JSON.parse(saved);
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ –ø—Ä–æ—Ç—É—Ö–ª–∏ (JWT –∂–∏–≤—ë—Ç ~1 —á–∞—Å, –Ω–æ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è —Ö—Ä–∞–Ω–∏–º 7 –¥–Ω–µ–π)
        if (user && user.email && user.savedAt && (Date.now() - user.savedAt < 7 * 24 * 60 * 60 * 1000)) {
          applyUser(user);
        } else {
          localStorage.removeItem('smartstore_user');
        }
      } catch(e) { localStorage.removeItem('smartstore_user'); }
    }
  };

  // --- 1. –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ---
  function handleCredentialResponse(response) {
    const payload = decodeJwtResponse(response.credential);
    const user = { email: payload.email, name: payload.name, picture: payload.picture, savedAt: Date.now() };
    localStorage.setItem('smartstore_user', JSON.stringify(user));
    applyUser(user);
  }

  function applyUser(user) {
    currentUser = user;
    document.getElementById('auth-zone').classList.add('d-none');
    document.getElementById('profile-zone').classList.remove('d-none');
    document.getElementById('profile-zone').classList.add('d-flex');
    document.getElementById('user-name').innerText = currentUser.name;
    document.getElementById('user-email').innerText = currentUser.email;
    document.getElementById('user-avatar').src = currentUser.picture;
    document.getElementById('custName').value = currentUser.name;
    document.querySelectorAll('.auth-only').forEach(el => el.classList.remove('auth-only'));
  }

  function signOut() {
    localStorage.removeItem('smartstore_user');
    location.reload();
  }

  function decodeJwtResponse(token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
  }

  // --- 2. –ü–û–õ–£–ß–ï–ù–ò–ï –¢–û–í–ê–†–û–í (FETCH GET) ---
  function loadProducts() {
    // –í–Ω–∏–º–∞–Ω–∏–µ: –¥–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä ?action=getProducts
    fetch(API_URL + '?action=getProducts')
      .then(res => res.json())
      .then(renderProducts)
      .catch(err => {
        console.error(err);
        document.getElementById('products-list').innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API_URL.</div>';
      });
  }

  function renderProducts(products) {
    const list = document.getElementById('products-list');
    list.innerHTML = '';
    if (!products || products.length === 0) { list.innerHTML = '<div class="text-center w-100 mt-5">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</div>'; return; }
    products.forEach(item => {
      list.innerHTML += `
        <div class="col"><div class="product-card h-100 d-flex flex-column">
          <div class="img-wrap"><img src="${item.ImageURL}" alt="${item.Title}"></div>
          <div class="p-3 flex-grow-1 d-flex flex-column">
            <h6 class="fw-bold m-0">${item.Title}</h6>
            <div class="mt-auto pt-3 border-top d-flex justify-content-between align-items-center">
              <span class="fw-bold fs-5">${item.Price} GEL</span>
              <button class="btn btn-primary btn-sm fw-bold" onclick="openModal('${item.ID}', '${item.Title}', ${item.Price}, ${item.Stock})">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
        </div></div>`;
    });
  }

  // --- 3. –û–¢–ü–†–ê–í–ö–ê –ó–ê–ö–ê–ó–ê (FETCH POST) ---
  document.getElementById('orderForm').onsubmit = function(e) {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    btn.disabled = true; btn.innerText = "–û—Ñ–æ—Ä–º–ª—è–µ–º...";

    // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞–∫–µ—Ç –¥–∞–Ω–Ω—ã—Ö
    const payload = {
      action: 'createOrder', // –ì–æ–≤–æ—Ä–∏–º —Å–µ—Ä–≤–µ—Ä—É, —á—Ç–æ –¥–µ–ª–∞—Ç—å
      payload: {
        id: document.getElementById('prodId').value,
        title: document.getElementById('prodTitle').value,
        count: document.getElementById('orderQty').value,
        name: document.getElementById('custName').value,
        phone: document.getElementById('custPhone').value,
        email: currentUser.email,
        totalPrice: document.getElementById('displayPrice').innerText
      }
    };

    // –í–ê–ñ–ù–û: mode: 'no-cors' –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º, GAS —É–º–µ–µ—Ç –≤ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify(payload) // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
    })
    .then(res => res.json())
    .then(result => {
      if(result.status === 'success') {
        alert("–ó–∞–∫–∞–∑ ‚Ññ " + result.orderId + " —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!");
        modal.hide();
        loadProducts(); // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–∫–∏
      } else {
        alert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + result.message);
      }
      btn.disabled = false; btn.innerText = "–ó–∞–∫–∞–∑–∞—Ç—å";
    })
    .catch(err => {
      alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏!");
      btn.disabled = false;
    });
  };

  // --- 4. –ü–û–õ–£–ß–ï–ù–ò–ï –ò–°–¢–û–†–ò–ò (FETCH POST) ---
  function loadMyOrders() {
    if(!currentUser) return;
    const container = document.getElementById('orders-container');
    container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';

    fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'getMyOrders',
        email: currentUser.email
      })
    })
    .then(res => res.json())
    .then(orders => {
      if (!orders.length) { container.innerHTML = '<div class="text-center py-5">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>'; return; }
      let html = '';
      orders.reverse().forEach(ord => {
        let dateStr = new Date(ord.Timestamp).toLocaleDateString();
        html += `<div class="order-row p-3 shadow-sm d-flex justify-content-between align-items-center">
          <div><div class="fw-bold">${ord.Product_Title} <span class="text-muted">x${ord.Quantity}</span></div>
          <small class="text-muted">–ó–∞–∫–∞–∑: ${ord.Order_ID} –æ—Ç ${dateStr}</small></div>
          <span class="badge bg-light text-dark border">${ord.Status}</span>
        </div>`;
      });
      container.innerHTML = html;
    });
  }

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ UI
  function openModal(id, title, price, stock) {
    if (!currentUser) { alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google!"); return; }
    document.getElementById('prodId').value = id;
    document.getElementById('prodTitle').value = title;
    document.getElementById('prodPrice').value = price;
    document.getElementById('prodStock').value = stock;
    document.getElementById('displayTitle').innerText = title;
    document.getElementById('displayPrice').innerText = price;
    document.getElementById('orderQty').value = 1;
    modal.show();
  }
  function updateQty(change) {
    const input = document.getElementById('orderQty');
    const max = parseInt(document.getElementById('prodStock').value);
    let val = parseInt(input.value) + change;
    if (val < 1) val = 1; if (val > max) val = max;
    input.value = val;
    document.getElementById('displayPrice').innerText = (parseFloat(document.getElementById('prodPrice').value) * val).toFixed(2);
  }
</script>

</body>
</html>